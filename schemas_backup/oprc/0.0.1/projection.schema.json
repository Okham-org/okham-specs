{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://okham.org/schemas/oprc/0.0.1/projection.schema.json",
  "title": "OPRC Projection Manifest",
  "description": "DRAFT v0.0.1 schema for Open Projection Contract (OPRC).",
  "type": "object",
  "required": ["oprc", "id", "name", "description", "status", "sources", "targets", "mapping"],
  "properties": {
    "oprc": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "OPRC specification version."
    },
    "id": {
      "type": "string",
      "description": "Projection identifier."
    },
    "name": {
      "type": "string",
      "description": "Human-readable name."
    },
    "description": {
      "type": "string",
      "description": "Projection purpose."
    },
    "status": {
      "type": "string",
      "enum": ["draft", "stable", "deprecated", "removed"],
      "description": "Lifecycle status."
    },
    "policyRefs": {
      "type": "array",
      "minItems": 1,
      "items": { "type": "string" },
      "description": "Optional OPC policy references."
    },
    "sources": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/source" },
      "description": "Source event bindings."
    },
    "targets": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/target" },
      "description": "Projection targets."
    },
    "mapping": {
      "$ref": "#/$defs/mapping"
    }
  },
  "additionalProperties": true,
  "$defs": {
    "source": {
      "type": "object",
      "required": ["eventId", "payloadType"],
      "properties": {
        "eventId": {
          "type": "string",
          "description": "OEC event identifier."
        },
        "payloadType": {
          "type": "string",
          "description": "OTC payload type identifier."
        },
        "filters": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/filter" },
          "description": "Optional filter predicates."
        },
        "causality": {
          "type": "object",
          "properties": {
            "fields": {
              "type": "array",
              "minItems": 1,
              "items": { "type": "string" }
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "filter": {
      "type": "object",
      "required": ["path"],
      "properties": {
        "path": { "type": "string" },
        "equals": {},
        "prefix": { "type": "string" }
      },
      "additionalProperties": true
    },
    "target": {
      "type": "object",
      "required": ["targetId", "kind", "mode"],
      "properties": {
        "targetId": { "type": "string" },
        "kind": {
          "type": "string",
          "enum": ["document", "state", "timeline", "metric"]
        },
        "mode": {
          "type": "string",
          "enum": ["append", "upsert"]
        },
        "key": { "type": "string" },
        "backend": { "type": "string" },
        "outputType": { "type": "string" }
      },
      "additionalProperties": true
    },
    "mapping": {
      "type": "object",
      "required": ["rules"],
      "properties": {
        "rules": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/mappingRule" }
        }
      },
      "additionalProperties": true
    },
    "mappingRule": {
      "type": "object",
      "required": ["targetId", "targetPath"],
      "properties": {
        "targetId": { "type": "string" },
        "targetPath": { "type": "string" },
        "sourceEventId": { "type": "string" },
        "copy": { "type": "string" },
        "const": {},
        "concat": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/concatPart" }
        }
      },
      "additionalProperties": true
    },
    "concatPart": {
      "type": "object",
      "properties": {
        "path": { "type": "string" },
        "const": { "type": "string" }
      },
      "additionalProperties": true
    }
  }
}
